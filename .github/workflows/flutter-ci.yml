name: Flutter CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  PROJECT_DIRECTORY: "azure_githubaction_flutter_app"
  JAVA_VERSION: "17"
  FLUTTER_CHANNEL: "stable"

jobs:
  build_apk:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Install Dependencies
        run: |
          cd ${{ env.PROJECT_DIRECTORY }}
          flutter pub get

      - name: Analyze
        run: |
          cd ${{ env.PROJECT_DIRECTORY }}
          flutter analyze

      - name: Run Tests
        run: |
          cd ${{ env.PROJECT_DIRECTORY }}
          flutter test

      # Setup Keystore for Signing (Requires Configuration)
      # You need to:
      # 1. Base64 encode your keystore: openssl base64 < my-upload-key.jks | tr -d '\n' | pbcopy
      # 2. Add KEYSTORE_BASE64 to GitHub Secrets
      # 3. Add KEY_PROPERTIES (storePassword, keyPassword, keyAlias, storeFile) logic or secrets.
      #
      # - name: Decode Keystore
      #   run: |
      #     echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
      #     # Create key.properties if not checking it in (recommended)
      #     echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
      #     echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
      #     echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
      #     echo "storeFile=upload-keystore.jks" >> android/key.properties
      #   working-directory: ${{ env.PROJECT_DIRECTORY }}

      - name: Build APK (Release)
        run: |
          cd ${{ env.PROJECT_DIRECTORY }}
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: release-apk
          path: ${{ env.PROJECT_DIRECTORY }}/build/app/outputs/flutter-apk/app-release.apk
